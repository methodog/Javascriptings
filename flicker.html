<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flicker - IIIF enabled stop-frame animator</title>
  <style type="text/css">
    html, body { margin:0; height:100%; }
    body { background:#000; font:14px/1 helvetica,arial,freesans,sans-serif; }
    .flicker { height:100%; margin:auto; position:relative; width:100%; }
    .flicker img { margin:auto; max-height:100%; max-width:100%; opacity:0; position:absolute; top:0; bottom:0; left:0; right:0; user-select:none; }
    .flicker img:nth-child(1) { opacity:1; }
    .ctrls { align-items:center; bottom:50px; color:#fff; display:flex; margin:auto; position:relative; width:56%; }
    .scrubber { flex:1; }
    .jitter { margin-left:10px; }
  </style>	
</head>

<body>
<!--
<div class="flicker" data-flicker-loop="true">
  <script type="text/javascript">var l=document.currentScript.parentNode; for( i=1; i<=171; ++i ){ l.innerHTML += `<img src="img/liam_st_paul/pure_${i.toString().padStart(3, '0')}.jpg" alt="">` };</script>
</div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>

<div class="flicker" data-flicker-loop="true"><img src="img/strober/horse00.jpg" alt=""><img src="img/strober/horse01.jpg" alt=""><img src="img/strober/horse02.jpg" alt=""><img src="img/strober/horse03.jpg" alt=""><img src="img/strober/horse04.jpg" alt=""><img src="img/strober/horse05.jpg" alt=""><img src="img/strober/horse06.jpg" alt=""><img src="img/strober/horse07.jpg" alt=""><img src="img/strober/horse08.jpg" alt=""><img src="img/strober/horse09.jpg" alt=""><img src="img/strober/horse10.jpg" alt=""><img src="img/strober/horse11.jpg" alt=""><img src="img/strober/horse12.jpg" alt=""><img src="img/strober/horse13.jpg" alt=""><img src="img/strober/horse14.jpg" alt=""><img src="img/strober/horse15.jpg" alt=""><img src="img/strober/horse16.jpg" alt=""><img src="img/strober/horse17.jpg" alt=""><img src="img/strober/horse18.jpg" alt=""><img src="img/strober/horse19.jpg" alt=""></div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>

<div class="flicker" data-flicker-loop="true"><img src="img/strober/camel00.jpg" alt=""><img src="img/strober/camel01.jpg" alt=""><img src="img/strober/camel02.jpg" alt=""><img src="img/strober/camel03.jpg" alt=""><img src="img/strober/camel04.jpg" alt=""><img src="img/strober/camel05.jpg" alt=""><img src="img/strober/camel06.jpg" alt=""><img src="img/strober/camel07.jpg" alt=""><img src="img/strober/camel08.jpg" alt=""><img src="img/strober/camel09.jpg" alt=""><img src="img/strober/camel10.jpg" alt=""><img src="img/strober/camel11.jpg" alt=""><img src="img/strober/camel12.jpg" alt=""><img src="img/strober/camel13.jpg" alt=""><img src="img/strober/camel14.jpg" alt=""></div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>
-->
<div class="flicker" data-flicker-fade="true">
  <!--http://archive.antiquity.ac.uk/projgall/sou348-->
  <script type="text/javascript">var l=document.currentScript.parentNode; for( i=0; i<=24; ++i ){ l.innerHTML += `<img src="img/strober/raking_light/${i.toString().padStart(2, '0')}.jpg" alt="">` };</script>
</div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
  <label><input title="jitter" class="jitter" type="checkbox">Jitter</label>
</div>

<div class="flicker">
  <script type="text/javascript">var l=document.currentScript.parentNode; for( i=1; i<=147; ++i ){ l.innerHTML += `<img src="https://www.apple.com/105/media/us/airpods-pro/2019/1299e2f5_9206_4470_b28e_08307a42f19b/anim/sequence/large/01-hero-lightpass/${i.toString().padStart(4, '0')}.jpg" alt="">` };</script>
</div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>

<div class="flicker" data-flicker-loop="true">
  <script type="text/javascript">var l=document.currentScript.parentNode; for( i=1; i<=36; ++i ){ l.innerHTML += `<img src="img/360/small/${i.toString().padStart(2, '0')}.jpg" alt="">` };</script>
</div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>

<div class="flicker" data-flicker-loop="true"><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.681,3.612,20.126,19.941/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.816,3.303,20.27,20.085/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.714,2.605,20.628,20.433/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.642,2.227,20.933,20.738/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:3.646,27.273,21.131,20.931/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.906,27.01,21.414,21.213/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.186,26.884,21.377,21.185/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.694,26.83,21.272,21.081/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:4.107,52.328,20.897,20.711/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:28.3,52.238,21.005,20.82/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:52.405,52.134,21.107,20.922/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.614,51.919,21.321,21.128/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:2.888,76.841,22.082,21.882/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:27.633,77.333,21.565,21.377/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:51.936,76.799,21.641,21.445/1920,/0/default.jpg 1920w" sizes=""><img src="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/1920,/0/default.jpg" srcset="https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/320,/0/default.jpg 320w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/640,/0/default.jpg 640w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/960,/0/default.jpg 960w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/1280,/0/default.jpg 1280w, https://iiif.wellcomecollection.org/image/V0048766.jpg/pct:76.154,76.155,21.743,21.553/1920,/0/default.jpg 1920w" sizes=""></div>
<div class="ctrls">
  <input title="animate" class="scrubber" type="range" min="0" step="10" max="" value="0">
</div>


<script src="img/manifesto.bundle.js"></script>
<script type="text/javascript">
Number.prototype.mod = function(n) { return ((this % n) + n) % n; }
const touchXY = (e) => {
  return e.touches ? [e.touches[0].pageX - e.target.getBoundingClientRect().x, e.touches[0].pageY - e.target.getBoundingClientRect().y] : [e.offsetX, e.offsetY];
}

const flicker = {
  el: null,
  xy0: null,
  v0: null,
  xyT: null,
  id: 0, 
  size: (el) => {
    el._props.wh = [
      Math.ceil(el.getBoundingClientRect().width),
      Math.ceil(el.getBoundingClientRect().height)
    ];
  },
  init: (el, opt = {}) => {
    if (typeof el === 'string') {
      el = document.getElementById(el);
    }
    if (!el) return;
    flicker.id += 1;
    if (!el.id) {
      el.id = el.className + flicker.id;
    }
    el._props = {
      val: opt.val || 0, 
      min: opt.min || 0, 
      max: opt.max || 1,
      v: [0, 0],
      loop: opt.loop || false,
      fade: opt.fade || false
    };
    el._props.rng = el._props.max - el._props.min;
    if (!el._props.css) {
      el._props.css = el.parentNode.insertBefore(document.createElement('style'), el);
    }
    flicker.size(el);
    el._props.arcs = el.getElementsByTagName('img').length;
    el._props.xy = [el.getBoundingClientRect().left, el.getBoundingClientRect().top];
    if (!el._props.move) {
      el.onmousedown = flicker.touch;
      el.ontouchstart = flicker.touch;
      el._props.move = (xy) => {
        let edge = 0;
        el._props.val = el._props.min + (xy[0] / el._props.wh[0] * (el._props.rng));
        if (el._props.loop) {
          el._props.val = el._props.val.mod(el._props.rng);
        }
        else if (el._props.val < el._props.min) {
          el._props.val = el._props.min;
          edge = 1;
        }
        else if (el._props.val > el._props.max) {
          el._props.val = el._props.max;
          edge = 1;
        }
        let vis = 1 + Math.ceil(el._props.val * el._props.arcs);
        if (vis > el._props.arcs) vis = el._props.arcs;
        let css = `
          #${el.id} img:nth-of-type(${vis}) { opacity: 1 }
        `;
        if (el._props.fade) {
          css += `
            #${el.id} img:nth-of-type(${vis + 1}) { opacity: ${((el._props.val % (1 / el._props.arcs)) * el._props.arcs).toFixed(2)} }
          `
        };
        window.requestAnimationFrame(() => {
          el._props.css.innerHTML = css;
        });
        if (!edge) el._props.xy = [xy[0], xy[1]];
      };
      el._props.drop = () => {
        const f = 0.98;
        el._props.v = [el._props.v[0] * f, el._props.v[1] * f];
        el._props.move([
          Math.round(el._props.xy[0] - el._props.v[0]),
          Math.round(el._props.xy[1] - el._props.v[1])
        ]);
        if (Math.abs(el._props.v[0]) + Math.abs(el._props.v[1]) > 0.5) {
          el._props.timeoutDrop = window.setTimeout(el._props.drop, 23);
        }
        else {
          flicker.v0 = el._props.v = [0, 0];
          window.clearTimeout(el._props.timeoutDrop);
        }
      };
      el._props.jitterAngle = 0;
      el._props.jitter = (on = true) => {
        if (on) {
          el._props.jitterAngle += Math.PI / 10;
          el._props.move([
            Math.round(el._props.xy[0] + (Math.sin(el._props.jitterAngle) * Math.random() * el._props.wh[0] / 134)),
            el._props.xy[1]
          ]);
          el._props.timeoutJitter = window.setTimeout(el._props.jitter, 23);
        }
        else {
          window.clearTimeout(el._props.timeoutJitter);
        }
      };
    }
  },
  touch: (e) => {
    if (e.type === 'touchstart' && e.touches && e.touches.length > 2) return false;
    flicker.el = e.currentTarget;
    window.clearTimeout(flicker.el._props.timeoutDrop);
    flicker.el.classList.add('dragged');
    flicker.v0 = flicker.el._props.v;
    flicker.el.v = [0, 0];
    flicker.xy0 = flicker.el._props.xy;
    flicker.xyT = touchXY(e);
    if (e.type === 'touchstart') {
      flicker.el.ontouchmove = flicker.drag;
      flicker.el.onmousedown = null;
      flicker.el.ontouchend = () => {
        flicker.el.ontouchmove = null;
        flicker.el.ontouchend = null;
        flicker.release();
      };
    } 
    else {
      document.onmousemove = flicker.drag;
      document.onmouseup = () => {
        document.onmousemove = null;
        document.onmouseup = null;
        flicker.release();
      };
    }
    return false;
  },
  drag: (e) => {
    const xyE = touchXY(e);
    const xy = [
      flicker.xy0[0] + xyE[0] - flicker.xyT[0],
      flicker.xy0[1] + xyE[1] - flicker.xyT[1]
    ];
    flicker.el._props.v = [
      flicker.el._props.xy[0] - xy[0],
      flicker.el._props.xy[1] - xy[1]
    ];
    flicker.el._props.move(xy);
    return false;
  },
  release: () => {
    flicker.el.classList.remove('dragged');
    if (flicker.el._props.loop) flicker.el._props.drop();
    flicker.el = null;
  }
};

const qstr = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')));
Array.from(document.querySelectorAll('.flicker'), (el) => {
  const loop = !!el.dataset.flickerLoop || false;
  const fade = !!el.dataset.flickerFade || false;
  if (!qstr.has('manifest')) {
    console.log(`try ${window.location}?manifest=https://vanda.github.io/iiif-features/img/manifest_muybridge.json`);
    flicker.init(el, {'loop': loop, 'fade': fade});
  } else {
    const m = qstr.get('manifest');
    manifesto.loadManifest(m).then((manifest) => {
      el.innerHTML = '';
      const mf = manifesto.create(manifest);

      if (!mf.context.includes('http://iiif.io/api/presentation/3/context.json')) {
        alert("Please provide a P3 manifest with the region of each frame as Fragment Selectors.");
      } else {
        const stack = mf.getAllRanges().find((range) => {
          return range.__jsonld.behavior.includes('superimpose-regions');
        });
        Array.from(stack.__jsonld.items, (item) => {
          const cv = mf.getSequences()[0].getCanvasById(item.source);
          const region = item.selector.region;
          const imgEl = el.appendChild(document.createElement('img'));
          let imgSrc = `${cv.getContent()[0].getBody()[0].id}.jpg`;
          let  imgSrcset = '';
          for (let size of [320, 640, 960, 1200, 1920]){
            imgSrcset += imgSrc.replace('full/full', `${region}/${size},`) + ` ${size}w, `;
          }
          imgEl.srcset = imgSrcset;
          imgEl.src = imgSrc.replace('full/full', `${region}/960,`);
          flicker.init(el, {'loop': loop, 'fade': fade});
        });
      }
    });
  }
});

window.addEventListener('resize', () => {
  Array.from(document.querySelectorAll('.flicker'), (el) => {
    flicker.size(el); 
  });
}, false);

Array.from(document.querySelectorAll('.scrubber'), (input) => {
  const flickerEl = input.parentElement.previousElementSibling;
  input.max = Math.round(flickerEl._props.wh[0] + 'e15') + 'e-15';
  input.step = Math.round(input.max / flickerEl._props.arcs + 'e15') + 'e-15';
  input.oninput = () => {
    flickerEl._props.move([parseInt(input.value), 0]);
  };
  input.value = Math.round(input.max / 2);
  input.oninput();
});

Array.from(document.querySelectorAll('.jitter'), (input) => {
  const flickerEl = input.closest('.ctrls').previousElementSibling;
  input.onchange = () => {
    flickerEl._props.jitter(input.checked);
  };
});

</script>
</body>
</html>
